<template>
  <div class="m-titled-artwork-upload">
    <div
      class="_step-title"
      :ref="getFieldAnchorName(fieldName)"
      v-if="title"
    >
      {{ title }}
    </div>

    <validation-provider
      tag="div"
      class="_wrapper"
      v-slot="{ errors }"
      :name="fieldName"
    >
      <input
        :name="`'${title}'`"
        type="hidden"
        :value="uploadedArtworkId"
        :required="isRequired"
      >

      <MArtworkUpload
        ref="artwork-upload"
        :product-id="backendProductId"
        :upload-url="uploadUrl"
        :disabled="disabled"
        :initial-items="initialArtworks"
        @file-added="$emit('file-added', $event)"
        @file-removed="$emit('file-removed', $event)"
        @is-busy-changed="$emit('is-busy-changed', $event)"
      />

      <div class="_error-text">
        {{ errors[0] }}
      </div>
    </validation-provider>
  </div>
</template>

<script lang="ts">
import Vue, { PropType } from 'vue';
import { TranslateResult } from 'vue-i18n';
import { ValidationProvider, extend } from 'vee-validate';
import { required } from 'vee-validate/dist/rules';

import { CustomerImage } from 'src/modules/shared';

import MArtworkUpload from './m-artwork-upload.vue';

extend('required', {
  ...required,
  message: 'The {_field_} field is required'
});

export default Vue.extend({
  name: 'MTitledArtworkUpload',
  components: {
    ValidationProvider,
    MArtworkUpload
  },
  props: {
    backendProductId: {
      type: String,
      required: true
    },
    uploadUrl: {
      type: String,
      required: true
    },
    disabled: {
      type: Boolean,
      default: false
    },
    initialArtworks: {
      type: Array as PropType<CustomerImage[]>,
      default: () => []
    },
    fieldName: {
      type: String,
      default: ''
    },
    title: {
      type: String as PropType<string | TranslateResult>,
      default: ''
    },
    uploadedArtwork: {
      type: Object as PropType<CustomerImage | undefined>,
      default: undefined
    },
    isRequired: {
      type: Boolean,
      default: false
    },
    getFieldAnchorName: {
      type: Function as PropType<(fieldName: string) => string>,
      required: true
    }
  },
  data () {
    return {
    }
  },
  computed: {
    uploadedArtworkId (): string | undefined {
      return this.uploadedArtwork?.id;
    }
  },
  methods: {
    clearInput (): void {
      const uploader = this.getUploader();
      if (!uploader) {
        return;
      }

      uploader.clearInput();
    },
    getUploader (): InstanceType<typeof MArtworkUpload> | undefined {
      return this.$refs['artwork-upload'] as InstanceType<typeof MArtworkUpload> | undefined;
    }
  }
})
</script>

<style lang="scss" scoped>

.m-titled-artwork-upload {
  ._step-title {
    font-size: var(--font-base);
    font-weight: 800;
    text-align: left;
  }

  ._wrapper {
    margin-top: var(--spacer-2xs);
  }

  ._error-text {
    color: var(--c-danger-variant);
    font-size: 0.8em;
    margin-top: var(--spacer-xs);
  }
}
</style>
