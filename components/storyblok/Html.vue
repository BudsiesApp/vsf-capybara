<template>
  <div
    class="storyblok-html-renderer"
    :class="cssClasses"
    :style="styles"
  >
    <editor-block-icons :item="itemData" />

    <div class="_no-script-html"
         v-html="noScriptHtml"
    />

    <div class="_script-container" ref="script-container" />
  </div>
</template>

<script lang="ts">
import { Blok } from 'src/modules/vsf-storyblok-module/components'

import HtmlData from './interfaces/html-data.interface';

export default Blok.extend({
  name: 'StoryblokHtmlRenderer',
  computed: {
    itemData (): HtmlData {
      return this.item as HtmlData;
    },
    noScriptHtml (): string {
      if (this.doesHtmlContainScript) {
        return '';
      }

      return this.itemData.html;
    },
    doesHtmlContainScript (): boolean {
      return this.itemData.html.includes('<script');
    }
  },
  mounted (): void {
    if (!this.doesHtmlContainScript) {
      return;
    }

    this.setHtml(this.itemData.html);
  },
  methods: {
    clearScriptContainer (): void {
      const container = this.$refs['script-container'] as HTMLElement | undefined;
      if (!container) {
        return;
      }

      container.innerHTML = '';
    },
    setHtml (html: string): void {
      const container = this.$refs['script-container'] as HTMLElement | undefined;
      if (!container) {
        return;
      }

      container.innerHTML = html;
      const scriptTags: HTMLScriptElement[] = Array.from(container.querySelectorAll('script'));

      for (const oldScript of scriptTags) {
        const newScript = document.createElement('script');
        const scriptAttributes: Attr[] = Array.from(oldScript.attributes);

        for (const attr of scriptAttributes) {
          newScript.setAttribute(attr.name, attr.value);
        }

        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
        oldScript.parentNode?.replaceChild(newScript, oldScript);
      }
    }
  },
  watch: {
    'itemData.html': {
      handler () {
        this.clearScriptContainer();

        if (!this.doesHtmlContainScript) {
          return;
        }

        this.setHtml(this.itemData.html);
      },
      immediate: false
    }
  }
})
</script>

<style lang="scss" scoped>
@import "~@storefront-ui/shared/styles/helpers/breakpoints";
@import "src/modules/vsf-storyblok-module/components/defaults/mixins";

.storyblok-html-renderer {
  &.-editor-preview-mode {
    ._no-script-html,
    ._script-container {
      pointer-events: none
    }
  }

  @include storyblok-default-margin;
  @include display-property-handling;
}
</style>
